#include <iostream>
#include "layer_common.hpp"

int main(int argc, char** argv) {
  std::cout << "--------------Test Conv2d start------------" << std::endl;
  Conv2d<double> test(3, 3, 3, 2, 1);
  auto input = xt::linspace<double>(-0.1, 0.5, 96).reshape({2, 3, 4, 4});
  auto weight = xt::linspace<double>(-0.2, 0.3, 81).reshape({3, 3, 3, 3});
  auto bias = xt::linspace<double>(-0.1, 0.2, 3);
  test.set_weight(weight);
  test.set_bias(bias);
  auto out = test.forward(input);
  //  Correct out:
  //  [[[[-0.07446053 -0.08099342]
  //   [-0.13984868 -0.19432237]]
  //
  //  [[ 0.10964474  0.14894079]
  //   [ 0.17641447  0.24823684]]
  //
  //  [[ 0.29375     0.378875  ]
  //   [ 0.49267763  0.69079605]]]
  //
  //
  // [[[-0.46098684 -0.67783553]
  //   [-0.77079605 -1.16632237]]
  //
  //  [[ 0.33701316  0.47294079]
  //   [ 0.46630921  0.6575    ]]
  //
  //  [[ 1.13501316  1.62371711]
  //   [ 1.70341447  2.48132237]]]]
  std::cout << out << std::endl;

  std::cout << "--------------------------" << std::endl;

  auto dinput = test.backward(out);
  //  Correct dinput:
  //  [[[[0.06007969 0.13415304 0.07481016 0.0776028 ]
  //   [0.15975493 0.37160551 0.21393405 0.22138113]
  //   [0.10343104 0.24679367 0.14470929 0.14936373]
  //   [0.11335436 0.2706803  0.15867262 0.16332706]]
  //
  //  [[0.07858224 0.17778935 0.09994391 0.10273655]
  //   [0.20802743 0.48690173 0.28095777 0.28840485]
  //   [0.13320099 0.31845358 0.18659926 0.1912537 ]
  //   [0.1431243  0.34234021 0.20056258 0.20521702]]
  //
  //  [[0.09708479 0.22142566 0.12507767 0.12787031]
  //   [0.25629992 0.60219794 0.3479815  0.35542858]
  //   [0.16297093 0.39011349 0.22848923 0.23314367]
  //   [0.17289424 0.41400012 0.24245255 0.24710699]]]
  //
  //
  // [[[0.263006   0.63997673 0.37951937 0.38838701]
  //   [0.66451283 1.63072919 0.97234984 0.9935456 ]
  //   [0.40877973 1.00840683 0.60321192 0.61554005]
  //   [0.43500962 1.07162109 0.6401963  0.65252442]]
  //
  //  [[0.31987697 0.77665646 0.45932813 0.46819576]
  //   [0.80007348 1.95705173 1.16311172 1.18430748]
  //   [0.48746941 1.19804963 0.71416505 0.72649317]
  //   [0.5136993  1.2612639  0.75114942 0.76347755]]
  //
  //  [[0.37674794 0.91333618 0.53913688 0.54800452]
  //   [0.93563413 2.28337426 1.3538736  1.37506937]
  //   [0.56615909 1.38769243 0.82511817 0.8374463 ]
  //   [0.59238898 1.4509067  0.86210255 0.87443067]]]]
  std::cout << dinput << std::endl;
  std::cout << "--------------Test Conv2d done------------" << std::endl;

  return 0;
}